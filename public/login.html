<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>登录</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#f6f7fb;--panel:#fff;--text:#1b1f29;--muted:#5b6476;--accent:#356dff;--accent2:#2558e6;--border:#e5e7ee;--radius:14px;--shadow:0 10px 24px rgba(23,27,41,.08)}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%, #eaf0ff 0%, rgba(234,240,255,0) 35%), var(--bg);font:14px/1.6 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;color:var(--text);height:100vh;display:grid;place-items:center}
    .card{width:360px;max-width:92vw;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .title{margin:0 0 12px;font-size:18px;font-weight:700;text-align:center}
    .row{display:grid;grid-template-columns:1fr;gap:10px;margin:10px 0}
    input{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fbfbfe;outline:none}
    input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(53,109,255,.16)}
    button{padding:10px 14px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(53,109,255,.24);transition:transform .2s, background .2s}
    button:hover{background:var(--accent2);transform:translateY(-1px)}
    .tip{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .err{color:#e04848;text-align:center;font-weight:600;min-height:20px}
  </style>
  </head>
<body>
  <div class="card">
    <h2 class="title">管理员登录</h2>
    <div id="loginBox">
      <div class="row"><input id="u" placeholder="用户名" autocomplete="username" /></div>
      <div class="row"><input id="p" type="password" placeholder="密码" autocomplete="current-password" /></div>
      <div class="row"><button id="btn">登录</button></div>
      <div id="err" class="err"></div>
      <div class="tip">仅限管理员使用</div>
    </div>
    <div id="changeBox" style="display:none">
      <div class="row"><input id="newp" type="password" placeholder="请设置新密码（至少 8 位）" autocomplete="new-password" /></div>
      <div class="row"><input id="newp2" type="password" placeholder="再次确认新密码" autocomplete="new-password" /></div>
      <div class="row"><button id="saveBtn">保存新密码</button></div>
      <div id="err2" class="err"></div>
      <div class="tip">为保证安全，首次登录或默认密码需立即修改</div>
    </div>
  </div>
  <script>
    const btn=document.getElementById('btn');
    btn.onclick=async()=>{
      const username=document.getElementById('u').value.trim();
      const password=document.getElementById('p').value.trim();
      const r=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});
      const d=await r.json().catch(()=>({}));
      if(r.ok){
        if(d && d.require_change===1){
          document.getElementById('loginBox').style.display='none';
          document.getElementById('changeBox').style.display='';
          const saveBtn=document.getElementById('saveBtn');
          saveBtn.onclick=async()=>{
            const np=document.getElementById('newp').value.trim();
            const np2=document.getElementById('newp2').value.trim();
            if(!np || np.length<8){ document.getElementById('err2').textContent='新密码长度至少 8 位'; return; }
            if(np!==np2){ document.getElementById('err2').textContent='两次输入不一致'; return; }
            const r2=await fetch('/auth/change_password',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_password:password,new_password:np})});
            if(r2.ok){ location.href='/'; } else { const d2=await r2.json().catch(()=>({message:'修改失败'})); document.getElementById('err2').textContent=d2.message||'修改失败'; }
          };
        } else {
          location.href='/';
        }
      } else {
        document.getElementById('err').textContent=(d && d.message) || '登录失败';
      }
    };
  </script>
</body>
</html>